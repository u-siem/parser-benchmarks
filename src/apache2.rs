use std::time::Instant;
use usiem::events::SiemLog;
use usiem::events::field::SiemIp;
use usiem_apache2::parsers::apache2;
use usiem_apache2::parsers::modsecurity;

pub fn benchmark_apache2(n_logs : usize) -> u128 {
    let log = "172.17.0.1 - - [23/Feb/2021:20:39:35 +0000] \"GET / HTTP/1.1\" 304 - \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0\" 465 164";
    let start_time = Instant::now();
    for _i in 0..n_logs {
        let log_event = SiemLog::new(log.to_owned(), 1000000 as i64, SiemIp::V4(0));
        let _logline = apache2::parse_log_combinedio(log_event).unwrap();
    }
    start_time.elapsed().as_millis()

}
pub fn benchmark_modsecurity(n_logs : usize) -> u128 {
    let log = "{\"transaction\":{\"time\":\"21/Feb/2021:23:16:17 +0000\",\"transaction_id\":\"YDLpwdKBz7is4x7ElBXe@gAAAEA\",\"remote_address\":\"172.17.0.1\",\"remote_port\":36296,\"local_address\":\"172.17.0.2\",\"local_port\":80},\"request\":{\"request_line\":\"GET /xss.html?default=%27OR%201=1-- HTTP/1.1\",\"headers\":{\"Host\":\"localhost:8080\",\"User-Agent\":\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0\",\"Accept\":\"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\",\"Accept-Language\":\"es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3\",\"Accept-Encoding\":\"gzip, deflate\",\"Connection\":\"keep-alive\",\"Upgrade-Insecure-Requests\":\"1\",\"Cache-Control\":\"max-age=0\"}},\"response\":{\"protocol\":\"HTTP/1.1\",\"status\":403,\"headers\":{\"Content-Length\":\"217\",\"Keep-Alive\":\"timeout=5, max=100\",\"Connection\":\"Keep-Alive\",\"Content-Type\":\"text/html; charset=iso-8859-1\"},\"body\":\"<!DOCTYPE HTML PUBLIC \\\"-//IETF//DTD HTML 2.0//EN\\\">\\n<html><head>\\n<title>403 Forbidden</title>\\n</head><body>\\n<h1>Forbidden</h1>\\n<p>You don't have permission to access /xss.html\\non this server.<br />\\n</p>\\n</body></html>\\n\"},\"audit_data\":{\"messages\":[\"Warning. detected SQLi using libinjection with fingerprint 's&1c' [file \\\"/usr/local/apache2/coreruleset/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf\\\"] [line \\\"65\\\"] [id \\\"942100\\\"] [msg \\\"SQL Injection Attack Detected via libinjection\\\"] [data \\\"Matched Data: s&1c found within ARGS:default: 'OR 1=1--\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-sqli\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/152/248/66\\\"] [tag \\\"PCI/6.5.2\\\"]\",\"Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file \\\"/usr/local/apache2/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf\\\"] [line \\\"150\\\"] [id \\\"949110\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Score: 5)\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-generic\\\"]\",\"Warning. Operator GE matched 5 at TX:inbound_anomaly_score. [file \\\"/usr/local/apache2/coreruleset/rules/RESPONSE-980-CORRELATION.conf\\\"] [line \\\"87\\\"] [id \\\"980130\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Inbound Score: 5 - SQLI=5,XSS=0,RFI=0,LFI=0,RCE=0,PHPI=0,HTTP=0,SESS=0): individual paranoia level scores: 5, 0, 0, 0\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"event-correlation\\\"]\"],\"error_messages\":[\"[file \\\"apache2_util.c\\\"] [line 273] [level 3] [client 172.17.0.1] ModSecurity: Warning. detected SQLi using libinjection with fingerprint 's&1c' [file \\\"/usr/local/apache2/coreruleset/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf\\\"] [line \\\"65\\\"] [id \\\"942100\\\"] [msg \\\"SQL Injection Attack Detected via libinjection\\\"] [data \\\"Matched Data: s&1c found within ARGS:default: 'OR 1=1--\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-sqli\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/152/248/66\\\"] [tag \\\"PCI/6.5.2\\\"] [hostname \\\"localhost\\\"] [uri \\\"/xss.html\\\"] [unique_id \\\"YDLpwdKBz7is4x7ElBXe@gAAAEA\\\"]\",\"[file \\\"apache2_util.c\\\"] [line 273] [level 3] [client 172.17.0.1] ModSecurity: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file \\\"/usr/local/apache2/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf\\\"] [line \\\"150\\\"] [id \\\"949110\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Score: 5)\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-generic\\\"] [hostname \\\"localhost\\\"] [uri \\\"/xss.html\\\"] [unique_id \\\"YDLpwdKBz7is4x7ElBXe@gAAAEA\\\"]\",\"[file \\\"apache2_util.c\\\"] [line 273] [level 3] [client 172.17.0.1] ModSecurity: Warning. Operator GE matched 5 at TX:inbound_anomaly_score. [file \\\"/usr/local/apache2/coreruleset/rules/RESPONSE-980-CORRELATION.conf\\\"] [line \\\"87\\\"] [id \\\"980130\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Inbound Score: 5 - SQLI=5,XSS=0,RFI=0,LFI=0,RCE=0,PHPI=0,HTTP=0,SESS=0): individual paranoia level scores: 5, 0, 0, 0\\\"] [ver \\\"OWASP_CRS/3.3.0\\\"] [tag \\\"event-correlation\\\"] [hostname \\\"localhost\\\"] [uri \\\"/xss.html\\\"] [unique_id \\\"YDLpwdKBz7is4x7ElBXe@gAAAEA\\\"]\"],\"action\":{\"intercepted\":true,\"phase\":2,\"message\":\"Operator GE matched 5 at TX:anomaly_score.\"},\"stopwatch\":{\"p1\":1283,\"p2\":1132,\"p3\":0,\"p4\":0,\"p5\":256,\"sr\":172,\"sw\":1,\"l\":0,\"gc\":0},\"response_body_dechunked\":true,\"producer\":[\"ModSecurity for Apache/2.9.3 (http://www.modsecurity.org/)\",\"OWASP_CRS/3.3.0\"],\"server\":\"Apache\",\"engine_mode\":\"ENABLED\"}}";
    let start_time = Instant::now();
    for _i in 0..n_logs {
        let log_event = SiemLog::new(log.to_owned(), 1000000 as i64, SiemIp::V4(0));
        let _logline = modsecurity::parse_log_json(log_event).unwrap();
    }
    start_time.elapsed().as_millis()

}